@page
@using Microsoft.AspNetCore.Authorization
@model ClinicaPsi.Web.Pages.Psicologo.PerfilModel
@{
    ViewData["Title"] = "Meu Perfil";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="gradient-text mb-0">
        <i class="bi bi-person-circle me-2"></i>
        Meu Perfil
    </h2>
    <div class="btn-group">
        <button type="button" class="btn btn-primary btn-modern" onclick="enableEdit()">
            <i class="bi bi-pencil me-2"></i>
            Editar Perfil
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="changePassword()">
            <i class="bi bi-key me-2"></i>
            Alterar Senha
        </button>
    </div>
</div>

<div class="row">
    <!-- Informações Pessoais -->
    <div class="col-md-8">
        <div class="card card-modern mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-person me-2"></i>
                    Informações Pessoais
                </h5>
            </div>
            <div class="card-body">
                <form asp-page-handler="AtualizarPerfil" method="post" id="perfilForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="nome" name="nome" 
                                   value="@Model.Psicologo.Nome" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   value="@Model.Psicologo.Email" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="crp" class="form-label">CRP</label>
                            <input type="text" class="form-control" id="crp" name="crp" 
                                   value="@Model.Psicologo.CRP" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="text" class="form-control" id="telefone" name="telefone" 
                                   value="@Model.Psicologo.Telefone" readonly>
                        </div>
                        <div class="col-md-12">
                            <label for="especialidades" class="form-label">Especialidades</label>
                            <textarea class="form-control" id="especialidades" name="especialidades" 
                                      rows="3" readonly>@Model.Psicologo.Especialidades</textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="valorConsulta" class="form-label">Valor da Consulta</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control" id="valorConsulta" 
                                       name="valorConsulta" value="@Model.Psicologo.ValorConsulta" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status</label>
                            <input type="text" class="form-control" 
                                   value="@(Model.Psicologo.Ativo ? "Ativo" : "Inativo")" readonly>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-none" id="editButtons">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="bi bi-check-circle me-2"></i>
                            Salvar Alterações
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Horários de Atendimento -->
        <div class="card card-modern">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock me-2"></i>
                    Horários de Atendimento
                </h5>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="editSchedule()">
                    <i class="bi bi-pencil"></i>
                    Editar
                </button>
            </div>
            <div class="card-body">
                <form asp-page-handler="AtualizarHorarios" method="post" id="horariosForm">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Dias da Semana</h6>
                            <div class="form-check-container">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="segunda" name="diasAtendimento" 
                                           value="Segunda" @(Model.Psicologo.AtendeSegunda ? "checked" : "") disabled>
                                    <label class="form-check-label" for="segunda">Segunda-feira</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="terca" name="diasAtendimento" 
                                           value="Terca" @(Model.Psicologo.AtendeTerca ? "checked" : "") disabled>
                                    <label class="form-check-label" for="terca">Terça-feira</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="quarta" name="diasAtendimento" 
                                           value="Quarta" @(Model.Psicologo.AtendeQuarta ? "checked" : "") disabled>
                                    <label class="form-check-label" for="quarta">Quarta-feira</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="quinta" name="diasAtendimento" 
                                           value="Quinta" @(Model.Psicologo.AtendeQuinta ? "checked" : "") disabled>
                                    <label class="form-check-label" for="quinta">Quinta-feira</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sexta" name="diasAtendimento" 
                                           value="Sexta" @(Model.Psicologo.AtendeSexta ? "checked" : "") disabled>
                                    <label class="form-check-label" for="sexta">Sexta-feira</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sabado" name="diasAtendimento" 
                                           value="Sabado" @(Model.Psicologo.AtendeSabado ? "checked" : "") disabled>
                                    <label class="form-check-label" for="sabado">Sábado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="domingo" name="diasAtendimento" 
                                           value="Domingo" @(Model.Psicologo.AtendeDomingo ? "checked" : "") disabled>
                                    <label class="form-check-label" for="domingo">Domingo</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Períodos</h6>
                            <div class="form-check-container">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="manha" name="periodosAtendimento" 
                                           value="Manha"                                            @(Model.Psicologo.AtendeManha ? "checked" : "") disabled>
                                    <label class="form-check-label" for="manha">
                                        Manhã (08:00 - 12:00)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="tarde" name="periodosAtendimento" 
                                           value="Tarde"                                            @(Model.Psicologo.AtendeTarde ? "checked" : "") disabled>
                                    <label class="form-check-label" for="tarde">
                                        Tarde (14:00 - 18:00)
                                    </label>
                                </div>

                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 d-none" id="scheduleButtons">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="bi bi-check-circle me-2"></i>
                            Salvar Horários
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelScheduleEdit()">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Estatísticas e Informações Adicionais -->
    <div class="col-md-4">
        <!-- Estatísticas Rápidas -->
        <div class="card card-modern mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Estatísticas
                </h5>
            </div>
            <div class="card-body">
                <div class="stat-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Total de Consultas</span>
                        <strong class="text-primary">@Model.TotalConsultas</strong>
                    </div>
                </div>
                <div class="stat-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Pacientes Ativos</span>
                        <strong class="text-success">@Model.PacientesAtivos</strong>
                    </div>
                </div>
                <div class="stat-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Receita Total</span>
                        <strong class="text-info">@Model.ReceitaTotal.ToString("C")</strong>
                    </div>
                </div>
                <div class="stat-item mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Taxa de Comparecimento</span>
                        <strong class="text-warning">@Model.TaxaComparecimento.ToString("N1")%</strong>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Membro desde</span>
                        <strong>@Model.Psicologo.DataCadastro.ToString("MMM/yyyy")</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Próximas Consultas -->
        <div class="card card-modern mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-event me-2"></i>
                    Próximas Consultas
                </h5>
            </div>
            <div class="card-body">
                @if (Model.ProximasConsultas.Any())
                {
                    @foreach (var consulta in Model.ProximasConsultas.Take(5))
                    {
                        <div class="consulta-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">@consulta.Paciente?.Nome</h6>
                                    <small class="text-muted">
                                        @consulta.DataHorario.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                                <span class="badge status-@consulta.Status.ToString().ToLower()">
                                    @consulta.Status.GetDisplayName()
                                </span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted">
                        <i class="bi bi-calendar-x mb-2" style="font-size: 2rem;"></i>
                        <p>Nenhuma consulta agendada</p>
                    </div>
                }
            </div>
        </div>

        <!-- Configurações da Conta -->
        <div class="card card-modern">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-gear me-2"></i>
                    Configurações
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <button type="button" class="list-group-item list-group-item-action" onclick="changePassword()">
                        <i class="bi bi-key me-2"></i>
                        Alterar Senha
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="configureNotifications()">
                        <i class="bi bi-bell me-2"></i>
                        Notificações
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="exportData()">
                        <i class="bi bi-download me-2"></i>
                        Exportar Dados
                    </button>
                    <button type="button" class="list-group-item list-group-item-action text-danger" onclick="deactivateAccount()">
                        <i class="bi bi-person-x me-2"></i>
                        Desativar Conta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Alterar Senha -->
<div class="modal fade" id="alterarSenhaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-page-handler="AlterarSenha" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-key me-2"></i>
                        Alterar Senha
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="senhaAtual" class="form-label">Senha Atual</label>
                        <input type="password" class="form-control" id="senhaAtual" name="senhaAtual" required>
                    </div>
                    <div class="mb-3">
                        <label for="novaSenha" class="form-label">Nova Senha</label>
                        <input type="password" class="form-control" id="novaSenha" name="novaSenha" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label for="confirmarSenha" class="form-label">Confirmar Nova Senha</label>
                        <input type="password" class="form-control" id="confirmarSenha" name="confirmarSenha" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>
                        Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function enableEdit() {
            // Habilitar campos
            document.querySelectorAll('#perfilForm input, #perfilForm textarea').forEach(input => {
                if (input.id !== 'crp' && input.id !== 'email') { // CRP e email não podem ser alterados
                    input.removeAttribute('readonly');
                }
            });
            
            // Mostrar botões
            document.getElementById('editButtons').classList.remove('d-none');
        }

        function cancelEdit() {
            // Desabilitar campos e reverter valores
            location.reload();
        }

        function editSchedule() {
            // Habilitar checkboxes
            document.querySelectorAll('#horariosForm input[type="checkbox"]').forEach(checkbox => {
                checkbox.removeAttribute('disabled');
            });
            
            // Mostrar botões
            document.getElementById('scheduleButtons').classList.remove('d-none');
        }

        function cancelScheduleEdit() {
            // Reverter alterações
            location.reload();
        }

        function changePassword() {
            const modal = new bootstrap.Modal(document.getElementById('alterarSenhaModal'));
            modal.show();
        }

        function configureNotifications() {
            alert('Configuração de notificações em desenvolvimento');
        }

        function exportData() {
            alert('Funcionalidade de exportação em desenvolvimento');
        }

        function deactivateAccount() {
            if (confirm('Tem certeza que deseja desativar sua conta? Esta ação pode ser revertida posteriormente.')) {
                alert('Funcionalidade em desenvolvimento');
            }
        }

        // Validação de confirmação de senha
        document.getElementById('confirmarSenha')?.addEventListener('input', function() {
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarSenha = this.value;
            
            if (novaSenha !== confirmarSenha) {
                this.setCustomValidity('As senhas não coincidem');
            } else {
                this.setCustomValidity('');
            }
        });
    </script>
}

<style>
    .stat-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .consulta-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .consulta-item:last-child {
        border-bottom: none;
    }

    .form-check-container .form-check {
        margin-bottom: 0.5rem;
    }

    .badge.status-agendada { background-color: #007bff; }
    .badge.status-confirmada { background-color: #28a745; }
    .badge.status-realizada { background-color: #6f42c1; }
    .badge.status-cancelada { background-color: #dc3545; }
</style>